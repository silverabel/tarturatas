<!DOCTYPE html>
<html>
<head>
<style>
  body {
    font-size: 3rem;
  }
  
  select {
    width: 100%;
    height: 10rem;
    font-size: 3rem;
  }
</style>
</head>
<body>
<select></select>
<script>
const KEY = 'stationIds';

const url = 'https://api.ratas.tartu.ee/cxf/am/station/';

const body = document
  .getElementsByTagName('body')[0];

const make = (n) => document.createElement(n);

const getIds = () => JSON.parse(
  localStorage.getItem(KEY) || '[]'
);

const setDetail = async p => {
  const b = await
    (await fetch(url + p.stationId)).json();
  
  p.innerHTML += b.lockedCycleTypeCount.map(({
    cycleType,
    countPrimary,
    countSecondary,
  }) => `
    ${cycleType}
    ${countPrimary} +
    ${countSecondary}`
  ).join(', ');
  
  body.append(p);
};

const stations = getIds().map(id => {
  const p = make('p');
  p.stationId = id;
  p.innerHTML = `{name}: Total {primary} + {secondary}, `;
  body.append(p);
  setDetail(p);
  
  return p;
});

const select = document.getElementsByTagName('select')[0];
    
select.onchange = () => {
  const id = select
    .options[select.selectedIndex]
    .station
    .id;
    
  localStorage.setItem(
    KEY,
    JSON.stringify([...getIds(), id]));
};

fetch(url + 'map/search', {
  method: 'POST',
  body: JSON.stringify({
    isPublic: true,
    limit: -1,
  }),
  headers: {
    'Content-Type': 'application/json',
  },
})
  .then(response => response.json())
  .then(({ results }) =>
    results.forEach(station => {
      const o = make('option');
      o.innerText = station.description;
      o.station = station;

      select.appendChild(o);
      
      const p = stations.find(({stationId}) => stationId === station.id);
      
      if (p) {
        p.innerHTML = p.innerHTML.replace('{name}', station. description).replace('{primary}', station.primaryLockedCycleCount).replace('{secondary}', station.secondaryLockedCycleCount);
      } 
  }));
  

</script>
</body>
</html>
