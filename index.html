<!DOCTYPE html>
<html>
<head>
<style>
  body {
    font-size: 2.5rem;
  }
  
  select {
    width: 100%;
    height: 10rem;
    font-size: 3rem;
  }
</style>
</head>
<body>
<select></select>
<script>
const KEY = 'stationIds';

const url = 'https://api.ratas.tartu.ee/cxf/am/station/';

const body = document
  .getElementsByTagName('body')[0];

const make = (n) => document.createElement(n);

const getIds = () => JSON.parse(
  localStorage.getItem(KEY) || '[]'
);

const setDetail = async div => {
  const b = await
    (await fetch(url + div.stationId)).json();
  
  div.p.innerHTML += b.lockedCycleTypeCount.map(({
    cycleType,
    countPrimary,
    countSecondary,
  }) => `
    ${cycleType}
    ${countPrimary} +
    ${countSecondary}`
  ).join(', ');
};

const stations = getIds().map(id => {
  const div = make('div');
  const h = make('h2');
  const p = make('p');
  div.append(h, p);
  div.stationId = id;
  div.h = h;
  div.p = p;
  p.innerHTML = `Total {primary} + {secondary}, `;
  body.append(div);
  setDetail(div);
  
  return div;
});
 
const select = document.getElementsByTagName('select')[0];
    
select.onchange = () => {
  const id = select
    .options[select.selectedIndex]
    .station
    .id;
    
  localStorage.setItem(
    KEY,
    JSON.stringify([...getIds(), id]));
};

fetch(url + 'map/search', {
  method: 'POST',
  body: JSON.stringify({
    isPublic: true,
    limit: -1,
  }),
  headers: {
    'Content-Type': 'application/json',
  },
})
  .then(response => response.json())
  .then(({ results }) =>
    results.forEach(station => {
      const o = make('option');
      o.innerText = station.description;
      o.station = station;

      select.appendChild(o);
      
      const div = stations.find(({stationId}) => stationId === station.id);
      
      if (div) {
        div.h.innerHTML = station.description;
        div.p.innerHTML = div.p.innerHTML.replace('{primary}', station.primaryLockedCycleCount).replace('{secondary}', station.secondaryLockedCycleCount);
      } 
  }));
  

</script>
</body>
</html>
